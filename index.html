<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CANSLIM Resources</title>
    <style>
        html, body { height: 100%; }
        body { font-family: Arial, sans-serif; margin: 0; background: radial-gradient(circle at top, #1f2b46, #0d1324 65%); color: #e6ecff; }
        .tabs { display: flex; background: rgba(7, 12, 24, 0.92); position: sticky; top: 0; z-index: 10; backdrop-filter: blur(6px); }
        .tab { padding: 12px 18px; color: #cbd5ff; cursor: pointer; user-select: none; transition: background 0.2s; }
        .tab:not(.active):hover { background: rgba(255, 255, 255, 0.08); }
        .tab.active { background: linear-gradient(135deg, #2563eb, #7c3aed); color: #fff; }
        .discord-link { margin-left: auto; text-decoration: none; display: inline-flex; align-items: center; gap: 10px; font-weight: 600; }
        .discord-link svg { width: 28px; height: 28px; fill: currentColor; }
        .content { display: none; padding: 28px; }
        .content.active { display: block; background: rgba(10, 16, 30, 0.82); min-height: calc(100vh - 60px); border-top: 1px solid rgba(255,255,255,0.05); box-shadow: 0 20px 45px rgba(5,8,18,0.55); border-radius: 0 0 18px 18px; backdrop-filter: blur(8px); }
        iframe { width: 100%; max-width: 560px; height: auto; aspect-ratio: 16 / 9; margin: 10px 0; border-radius: 12px; border: 1px solid rgba(255,255,255,0.08); background: #000; }
        ul { list-style: none; padding: 0; margin: 0; }
        li { margin: 10px 0; }
        a { color: #60a5ff; word-break: break-all; text-decoration: none; }
        a:hover { text-decoration: underline; }
        .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 14px; }
        img, video { max-width: 100%; height: auto; border-radius: 6px; }
        video { border: 1px solid #dfe3e8; background: #000; }
        .video-player { width: 100%; max-width: 560px; height: auto; aspect-ratio: 16 / 9; border-radius: 6px; display: block; object-fit: cover; }
        .gallery-item { background: rgba(255,255,255,0.03); padding: 10px; border: 1px solid rgba(255,255,255,0.06); border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.35); display: flex; flex-direction: column; gap: 8px; }
        .media-card { margin-bottom: 24px; padding: 16px; border: 1px solid rgba(255,255,255,0.04); border-radius: 12px; background: rgba(17,24,39,0.8); box-shadow: 0 12px 30px rgba(0,0,0,0.35); }
        .media-card h3 { margin: 0 0 8px 0; font-size: 1rem; color: #e3e8ff; }
        .empty-state { color: #9ba6c7; font-style: italic; margin: 0; }
        .youtube-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 24px; }
        .youtube-card { border: 1px solid rgba(255,255,255,0.07); border-radius: 14px; padding: 18px; background: linear-gradient(160deg, rgba(7,11,23,0.95), rgba(20,27,46,0.9)); box-shadow: 0 20px 35px rgba(0,0,0,0.45); display: flex; flex-direction: column; align-items: center; gap: 12px; }
        .youtube-card h3 { text-align: center; }
        .link-list { list-style: decimal; padding-left: 24px; margin-top: 12px; }
        .link-list li { margin-bottom: 12px; }
        .link-title { font-weight: 600; display: block; margin-bottom: 2px; color: #93c5ff; }
        .link-url { font-size: 0.85rem; color: #c1c9e8; word-break: break-all; display: block; }
        .pdf-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 16px; }
        .pdf-card { border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 14px; background: rgba(255,255,255,0.03); box-shadow: 0 10px 24px rgba(0,0,0,0.35); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .pdf-card:hover { transform: translateY(-4px); box-shadow: 0 16px 32px rgba(0,0,0,0.45); }
        .pdf-thumb { width: 100%; height: 220px; object-fit: cover; background: linear-gradient(135deg,#1e293b,#334155); border-radius: 10px; border: 1px solid rgba(255,255,255,0.08); }
        .pdf-title { margin-top: 10px; font-weight: 600; color: #e8edff; }
        .media-caption { font-size: 0.9rem; color: #b6c2e6; margin: 0; }
        .gallery-item img { cursor: zoom-in; }
        .lightbox { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(3,6,17,0.85); opacity: 0; pointer-events: none; transition: opacity 0.25s ease; z-index: 100; padding: 20px; }
        .lightbox.visible { opacity: 1; pointer-events: auto; }
        .lightbox.hidden { display: none; }
        .lightbox-overlay { position: absolute; inset: 0; }
        .lightbox-inner { position: relative; max-width: 90vw; max-height: 90vh; background: #fff; border-radius: 10px; padding: 16px; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .lightbox-inner img { max-width: 85vw; max-height: 80vh; object-fit: contain; border-radius: 6px; cursor: zoom-out; }
        .lightbox-close { position: absolute; top: 6px; right: 10px; border: none; background: transparent; font-size: 1.5rem; cursor: pointer; color: #333; }
        .books-hero { margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 18px; align-items: start; }
        .books-hero img { width: 100%; border-radius: 16px; border: 2px solid #0f172a; box-shadow: 0 15px 35px rgba(15,23,42,0.45); display: block; }
        .books-link { font-weight: 600; color: #d97706; }
        .support-modal { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(4, 6, 15, 0.85); opacity: 0; pointer-events: none; transition: opacity 0.3s ease; z-index: 200; padding: 20px; }
        .support-modal.visible { opacity: 1; pointer-events: auto; }
        .support-card { background: linear-gradient(145deg, #11193a, #060a1f); border: 1px solid rgba(255,255,255,0.08); border-radius: 18px; padding: 28px; max-width: 460px; color: #f4f8ff; box-shadow: 0 30px 60px rgba(0,0,0,0.6); text-align: center; position: relative; }
        .support-card h3 { margin-top: 0; font-size: 1.5rem; }
        .support-card p { color: #cad5f7; }
        .support-close { position: absolute; top: 12px; right: 12px; border: none; background: transparent; color: #fff; font-size: 1.3rem; cursor: pointer; }
        .support-cta { margin-top: 16px; display: inline-flex; align-items: center; gap: 8px; padding: 10px 18px; background: linear-gradient(135deg,#fbbf24,#f97316); color: #150f02; font-weight: 700; border-radius: 999px; text-decoration: none; box-shadow: 0 10px 20px rgba(249,115,22,0.35); }
        .page-loader { position: fixed; inset: 0; background: radial-gradient(circle at top, rgba(8,12,25,0.95), rgba(2,5,14,0.96)); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 14px; z-index: 400; transition: opacity 0.3s ease; }
        .page-loader.hidden { opacity: 0; pointer-events: none; }
        .page-loader .spinner { width: 58px; height: 58px; border-radius: 50%; border: 5px solid rgba(255,255,255,0.2); border-top-color: #60a5ff; animation: spin 0.9s linear infinite; }
        .page-loader p { margin: 0; color: #dbeafe; letter-spacing: 0.04em; text-transform: uppercase; font-size: 0.85rem; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-846VJ90DLC"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-846VJ90DLC');
</script>
<body>
    <div id="page-loader" class="page-loader">
        <div class="spinner"></div>
        <p>Loading resources for better experience.<br>Thanks for your patience!</p>
    </div>
    <div class="tabs">
        <div class="tab active" onclick="showTab(event, 'home')">Home</div>
        <div class="tab" onclick="showTab(event, 'motivation')">Motivation</div>
        <div class="tab" onclick="showTab(event, 'pdfs')">PDFs</div>
        <div class="tab" onclick="showTab(event, 'youtube')">YouTube</div>
        <div class="tab" onclick="showTab(event, 'images')">Images</div>
        <div class="tab" onclick="showTab(event, 'videos')">Videos</div>
        <div class="tab" onclick="showTab(event, 'books')">Books✨</div>
        <a class="tab discord-link" href="https://discord.gg/xUz3nXZ3p5" target="_blank" rel="noopener noreferrer">
            <span>Discord</span>
        </a>
    </div>

    <div id="home" class="content active">
        <h2>Other Links</h2>
        <ol id="other-links" class="link-list"></ol>
    </div>

    <div id="motivation" class="content">
        <h2>Motivation</h2>
        <ol id="motivation-links" class="link-list"></ol>
    </div>

    <div id="pdfs" class="content">
        <h2>PDFs</h2>
        <div id="pdf-list" class="pdf-grid"></div>
    </div>

    <div id="youtube" class="content">
        <h2>YouTube Videos</h2>
        <div id="youtube-videos" class="youtube-grid"></div>
    </div>

    <div id="images" class="content">
        <h2>Images</h2>
        <div id="images-gallery" class="gallery"></div>
    </div>

    <div id="videos" class="content">
        <h2>Discord Videos</h2>
        <div id="videos-gallery" class="gallery"></div>
    </div>

    <div id="books" class="content">
        <h2>Support the community to gain access to the full CANSLIM books library.</h2>
        <p>
            Pitch in to keep the resource growing and unlock the curated bookshelf by backing us on
            <a class="books-link" href="http://ko-fi.com/ibd_canslim_investor_network/tiers" target="_blank" rel="noopener noreferrer">Ko-fi</a>.
        </p>
        <div class="books-hero">
            <img src="https://media.discordapp.net/attachments/1347564075407904768/1434804102650662984/image.png?ex=6912e373&is=691191f3&hm=68d6fcf6c57a1d4092e2d50f5a59c010cf071509e6b6c7c065a4911a7c482544&=&format=webp&quality=lossless&width=611&height=577" alt="CANSLIM book list preview">
            <img src="https://media.discordapp.net/attachments/1347564075407904768/1434804103782862909/image.png?ex=6912e373&is=691191f3&hm=91c8901ca8f840941c1482767ab910d0e168007b8dbc127025b517c7c33cc36b&=&format=webp&quality=lossless&width=651&height=264" alt="CANSLIM book list preview2">
        </div>
    </div>

    <div id="support-modal" class="support-modal" aria-hidden="true">
        <div class="support-card">
            <button class="support-close" aria-label="Close support message">&times;</button>
            <h3>Support the CANSLIM Community</h3>
            <p>Help us maintain the research archive, book scans, and curated notes for fellow investors.</p>
            <a class="support-cta" href="http://ko-fi.com/ibd_canslim_investor_network/tiers" target="_blank" rel="noopener noreferrer">Back us on Ko-fi</a>
        </div>
    </div>

    <div id="image-lightbox" class="lightbox hidden">
        <div class="lightbox-overlay" data-lightbox-close></div>
        <div class="lightbox-inner">
            <button class="lightbox-close" aria-label="Close image preview" data-lightbox-close>&times;</button>
            <img id="lightbox-photo" src="" alt="Enlarged preview">
            <p id="lightbox-caption"></p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.js" integrity="sha512-O5bY5p+qZ+nhewc7ovQoPGwTpghSJOnA7xz/ES6sDIo8He3G6gZj/O9oYF6W1hLECPaKhLPgH8JbImTeTTKQ0g==" crossorigin="anonymous"></script>
    <script src="results-inline.js"></script>
    <script>
        const loaderElement = document.getElementById('page-loader');
        const inlineResults = window.inlineScrapedResults || null;
        const scrapedDataPromise = loadScrapedData();

        const PDF_WORKER_SRC = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.worker.min.js';
        if (window.pdfjsLib && pdfjsLib.GlobalWorkerOptions) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = PDF_WORKER_SRC;
        }

        const lightboxState = { container: null, image: null, caption: null };
        let supportTimer = null;
        const youtubeTitleCache = new Map();

        async function loadScrapedData() {
            if (window.scrapedData && Array.isArray(window.scrapedData.links)) {
                return window.scrapedData;
            }

            try {
                const response = await fetch('results.txt', { cache: 'no-store' });
                if (!response.ok) {
                    throw new Error(`Failed to fetch results.txt (${response.status})`);
                }
                const payload = await response.json();
                const normalized = normalizePayload(payload);
                window.scrapedData = normalized;
                return normalized;
            } catch (error) {
                if (inlineResults) {
                    console.warn('Falling back to inline results bundle.', error);
                    const normalized = normalizePayload(inlineResults);
                    window.scrapedData = normalized;
                    return normalized;
                }
                console.error('Unable to load results from results.txt', error);
                return getEmptyData();
            }
        }

        function normalizePayload(payload = {}) {
            const resource = payload.resource || {};
            const motivation = payload.motivation || {};

            return {
                links: resource.links || [],
                images: resource.images || [],
                videos: resource.videos || [],
                motivation: motivation.links || []
            };
        }

        function getEmptyData() {
            return { links: [], images: [], videos: [], motivation: [] };
        }

        document.addEventListener('DOMContentLoaded', () => {
            setupLightbox();
            scheduleSupportModal();
            showLoader();
            const dataLoad = scrapedDataPromise.then(populateDashboard);
            const minimumDelay = new Promise(resolve => setTimeout(resolve, 12000));
            Promise.allSettled([dataLoad, minimumDelay])
                .finally(() => hideLoader());
        });

        async function populateDashboard(data) {
            const safeData = data || { links: [], images: [], videos: [], motivation: [] };
            const uniqueImages = uniqueList(safeData.images);
            const uniqueVideos = uniqueList(safeData.videos);
            const { pdfLinks, youtubeVideos, otherLinks } = categorizeLinks(safeData.links);
            const motivationLinks = buildLinkItems(safeData.motivation);
            const imageItems = uniqueImages.map(src => ({ src, label: buildImageLabel(src) }));
            const videoItems = uniqueVideos.map(src => ({ src, label: buildMediaLabel(src) }));

            renderPdfGallery('pdf-list', pdfLinks, 'No PDFs available yet.');
            renderLinkList('other-links', otherLinks, 'No other links available yet.');
            renderLinkList('motivation-links', motivationLinks, 'No motivation links available yet.');
            await renderYoutubeVideos('youtube-videos', youtubeVideos, 'No YouTube videos found.');
            renderGallery('images-gallery', imageItems, 'image', 'No images to display.');
            renderGallery('videos-gallery', videoItems, 'video', 'No videos to display.');
        }

        function categorizeLinks(links = []) {
            const pdfLinks = [];
            const youtubeVideos = [];
            const otherLinks = [];
            const seen = new Set();

            (links || []).forEach(rawLink => {
                if (!rawLink) return;
                const link = rawLink.trim();
                if (!link || seen.has(link)) return;
                seen.add(link);

                if (isPdf(link)) {
                    pdfLinks.push({ url: link, label: buildDocumentLabel(link) });
                    return;
                }

                const youtubeId = extractYoutubeId(link);
                if (youtubeId) {
                    youtubeVideos.push({ url: link, id: youtubeId, label: buildYoutubeLabel(link, youtubeId) });
                    return;
                }

                otherLinks.push({ url: link, label: buildGenericLabel(link) });
            });

            return { pdfLinks, youtubeVideos, otherLinks };
        }

        function buildLinkItems(links = []) {
            const items = [];
            const seen = new Set();

            (links || []).forEach(rawLink => {
                if (!rawLink) return;
                const link = rawLink.trim();
                if (!link || seen.has(link)) return;
                seen.add(link);

                if (isPdf(link)) {
                    items.push({ url: link, label: buildDocumentLabel(link) });
                    return;
                }

                const youtubeId = extractYoutubeId(link);
                if (youtubeId) {
                    items.push({ url: link, label: buildYoutubeLabel(link, youtubeId) });
                    return;
                }

                items.push({ url: link, label: buildGenericLabel(link) });
            });

            return items;
        }

        function renderLinkList(containerId, items, emptyText) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';

            if (!items.length) {
                const li = document.createElement('li');
                li.className = 'empty-state';
                li.textContent = emptyText;
                container.appendChild(li);
                return;
            }

            const fragment = document.createDocumentFragment();
            items.forEach(item => {
                const li = document.createElement('li');
                const titleLink = document.createElement('a');
                titleLink.className = 'link-title';
                titleLink.href = item.url;
                titleLink.target = '_blank';
                titleLink.rel = 'noopener noreferrer';
                titleLink.textContent = item.label;

                const urlCopy = document.createElement('span');
                urlCopy.className = 'link-url';
                urlCopy.textContent = formatDisplayUrl(item.url);

                li.appendChild(titleLink);
                li.appendChild(urlCopy);
                fragment.appendChild(li);
            });
            container.appendChild(fragment);
        }

        function renderPdfGallery(containerId, pdfs, emptyText) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';

            if (!pdfs.length) {
                const msg = document.createElement('p');
                msg.className = 'empty-state';
                msg.textContent = emptyText;
                container.appendChild(msg);
                return;
            }

            const fragment = document.createDocumentFragment();
            pdfs.forEach(pdf => {
                const card = document.createElement('div');
                card.className = 'pdf-card';
                card.tabIndex = 0;

                const thumb = document.createElement('img');
                thumb.className = 'pdf-thumb';
                thumb.alt = `${pdf.label} preview`;
                thumb.src = createPdfPlaceholder(pdf.label);

                const title = document.createElement('div');
                title.className = 'pdf-title';
                title.textContent = pdf.label;

                card.appendChild(thumb);
                card.appendChild(title);
                card.addEventListener('click', () => window.open(pdf.url, '_blank', 'noopener'));
                card.addEventListener('keypress', event => {
                    if (event.key === 'Enter') {
                        window.open(pdf.url, '_blank', 'noopener');
                    }
                });

                fragment.appendChild(card);
                loadPdfThumbnail(pdf.url, thumb);
            });
            container.appendChild(fragment);
        }

        function renderYoutubeVideos(containerId, videos, emptyText) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';

            if (!videos.length) {
                const msg = document.createElement('p');
                msg.className = 'empty-state';
                msg.textContent = emptyText;
                container.appendChild(msg);
                return;
            }

            const fragment = document.createDocumentFragment();
            const pendingTitles = [];
            videos.forEach(video => {
                const wrapper = document.createElement('div');
                wrapper.className = 'media-card youtube-card';

                const heading = document.createElement('h3');
                heading.textContent = 'Loading title…';

                const iframe = document.createElement('iframe');
                iframe.src = `https://www.youtube-nocookie.com/embed/${video.id}?rel=0&modestbranding=1`;
                iframe.frameBorder = '0';
                iframe.allowFullscreen = true;
                iframe.setAttribute('loading', 'lazy');
                iframe.setAttribute('referrerpolicy', 'strict-origin-when-cross-origin');
                iframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share');

                const pending = fetchYoutubeTitle(video).then(title => {
                    heading.textContent = title;
                }).catch(() => {
                    heading.textContent = video.label || `YouTube Video (${video.id})`;
                });
                pendingTitles.push(pending);

                wrapper.appendChild(heading);
                wrapper.appendChild(iframe);
                fragment.appendChild(wrapper);
            });
            container.appendChild(fragment);
            return Promise.allSettled(pendingTitles);
        }

        function renderGallery(containerId, items, type, emptyText) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';

            if (!items.length) {
                const msg = document.createElement('p');
                msg.className = 'empty-state';
                msg.textContent = emptyText;
                container.appendChild(msg);
                return;
            }

            const fragment = document.createDocumentFragment();
            items.forEach(item => {
                const cell = document.createElement('div');
                cell.className = 'gallery-item';

                if (type === 'image') {
                    const img = document.createElement('img');
                    img.src = item.src;
                    img.alt = item.label || 'Discord image';
                    img.loading = 'lazy';
                    img.addEventListener('click', () => openLightbox(item.src, item.label));

                    cell.appendChild(img);
                } else {
                    const video = document.createElement('video');
                    video.className = 'video-player';
                    video.controls = true;
                    video.preload = 'metadata';
                    const source = document.createElement('source');
                    source.src = item.src;
                    source.type = guessMimeType(item.src);
                    video.appendChild(source);

                    const caption = document.createElement('p');
                    caption.className = 'media-caption';
                    caption.textContent = item.label;

                    const fallback = document.createElement('a');
                    fallback.href = item.src;
                    fallback.target = '_blank';
                    fallback.rel = 'noopener noreferrer';
                    fallback.textContent = 'Open video';

                    cell.appendChild(caption);
                    cell.appendChild(video);
                    cell.appendChild(fallback);
                }

                fragment.appendChild(cell);
            });
            container.appendChild(fragment);
        }

        function uniqueList(items = []) {
            return Array.from(new Set(items.map(item => item?.trim()).filter(Boolean)));
        }

        function isPdf(link) {
            return /\.pdf(\?|$)/i.test(link);
        }

        function extractYoutubeId(link) {
            try {
                const url = new URL(link);
                const host = url.hostname.replace(/^www\./, '');

                if (host === 'youtu.be') {
                    return url.pathname.replace('/', '');
                }

                if (host.endsWith('youtube.com')) {
                    if (url.pathname === '/watch') {
                        return url.searchParams.get('v');
                    }
                    if (url.pathname.startsWith('/live/')) {
                        return url.pathname.split('/')[2];
                    }
                    if (url.pathname.startsWith('/shorts/')) {
                        return url.pathname.split('/')[2];
                    }
                }
            } catch (error) {
                return null;
            }
            return null;
        }

        function buildDocumentLabel(link) {
            const name = extractLastSegment(link);
            return name || 'PDF Document';
        }

        function buildYoutubeLabel(link, fallbackId) {
            const name = extractLastSegment(link);
            return name || `YouTube Video (${fallbackId})`;
        }

        function buildGenericLabel(link) {
            try {
                const url = new URL(link);
                let path = url.pathname;
                if (path.length > 50) {
                    path = `${path.slice(0, 47)}...`;
                }
                return `${url.hostname}${path === '/' ? '' : path}`;
            } catch (error) {
                return link;
            }
        }

        function buildImageLabel(link) {
            const segment = extractLastSegment(link);
            return segment || getHostname(link) || 'Image';
        }

        function buildMediaLabel(link) {
            const host = getHostname(link);
            const segment = extractLastSegment(link);
            const isDiscordCdn = host?.includes('cdn.discordapp.com');
            if (segment && (!host || isDiscordCdn)) return segment;
            if (segment && host) return `${host} • ${segment}`;
            return segment || host || 'Video';
        }

        function getHostname(link) {
            try {
                const url = new URL(link);
                return url.hostname;
            } catch (error) {
                return '';
            }
        }

        function extractLastSegment(link) {
            try {
                const url = new URL(link);
                const segments = url.pathname.split('/').filter(Boolean);
                if (!segments.length) {
                    return url.hostname;
                }
                const lastSegment = decodeURIComponent(segments.pop());
                return lastSegment.replace(/\.[a-z0-9]+$/i, '').replace(/[-_]+/g, ' ').trim();
            } catch (error) {
                return link;
            }
        }

        function guessMimeType(src) {
            const ext = src.split('.').pop()?.split('?')[0]?.toLowerCase();
            if (ext === 'webm') return 'video/webm';
            return 'video/mp4';
        }

        function formatDisplayUrl(link) {
            try {
                const url = new URL(link);
                const path = url.pathname === '/' ? '' : url.pathname;
                const search = url.search || '';
                return `${url.hostname}${path}${search}`;
            } catch (error) {
                return link;
            }
        }

        function createPdfPlaceholder(label = 'PDF Document') {
            const canvas = document.createElement('canvas');
            canvas.width = 400;
            canvas.height = 520;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#eef2ff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#dbe4ff';
            ctx.fillRect(0, 0, canvas.width, 140);
            ctx.fillStyle = '#1d4ed8';
            ctx.font = 'bold 56px "Segoe UI", Arial';
            ctx.fillText('PDF', 140, 90);
            ctx.fillStyle = '#1f2937';
            ctx.font = '24px "Segoe UI", Arial';
            wrapText(ctx, label, 30, 200, 340, 30);
            return canvas.toDataURL('image/png');
        }

        async function loadPdfThumbnail(url, imgElement) {
            if (!window.pdfjsLib || !imgElement) return;
            const preview = await generatePdfThumbnail(url);
            if (preview) {
                imgElement.src = preview;
            }
        }

        async function generatePdfThumbnail(url) {
            if (!window.pdfjsLib) return null;
            try {
                const loadingTask = pdfjsLib.getDocument({ url, withCredentials: false });
                const pdf = await loadingTask.promise;
                const page = await pdf.getPage(1);
                const viewport = page.getViewport({ scale: 0.5 });
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                await page.render({ canvasContext: context, viewport }).promise;
                const dataUrl = canvas.toDataURL('image/png');
                if (typeof pdf.cleanup === 'function') {
                    pdf.cleanup();
                }
                if (typeof pdf.destroy === 'function') {
                    pdf.destroy();
                }
                return dataUrl;
            } catch (error) {
                console.warn('Unable to generate PDF preview for', url, error);
                return null;
            }
        }

        function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
            const words = text.split(/\s+/);
            let line = '';
            words.forEach(word => {
                const testLine = `${line}${word} `;
                const { width } = ctx.measureText(testLine);
                if (width > maxWidth && line) {
                    ctx.fillText(line.trim(), x, y);
                    line = `${word} `;
                    y += lineHeight;
                } else {
                    line = testLine;
                }
            });
            if (line.trim()) {
                ctx.fillText(line.trim(), x, y);
            }
        }

        function setupLightbox() {
            const container = document.getElementById('image-lightbox');
            if (!container) return;
            lightboxState.container = container;
            lightboxState.image = document.getElementById('lightbox-photo');
            lightboxState.caption = document.getElementById('lightbox-caption');

            container.querySelectorAll('[data-lightbox-close]').forEach(element => {
                element.addEventListener('click', closeLightbox);
            });

            container.addEventListener('click', event => {
                if (event.target === container || event.target.classList.contains('lightbox-overlay')) {
                    closeLightbox();
                }
            });

            document.addEventListener('keydown', event => {
                if (event.key === 'Escape') {
                    closeLightbox();
                }
            });
        }

        function openLightbox(src, caption) {
            if (!lightboxState.container) {
                window.open(src, '_blank', 'noopener');
                return;
            }
            lightboxState.image.src = src;
            lightboxState.image.alt = caption || 'Image preview';
            lightboxState.caption.textContent = caption || '';
            lightboxState.container.classList.remove('hidden');
            requestAnimationFrame(() => lightboxState.container.classList.add('visible'));
        }

        function closeLightbox() {
            if (!lightboxState.container || lightboxState.container.classList.contains('hidden')) return;
            lightboxState.container.classList.remove('visible');
            setTimeout(() => {
                lightboxState.container.classList.add('hidden');
                lightboxState.image.src = '';
                lightboxState.caption.textContent = '';
            }, 200);
        }

        function scheduleSupportModal() {
            const modal = document.getElementById('support-modal');
            if (!modal) return;
            const closeBtn = modal.querySelector('.support-close');
            const hideModal = () => {
                modal.classList.remove('visible');
                modal.setAttribute('aria-hidden', 'true');
            };
            closeBtn?.addEventListener('click', hideModal);
            modal.addEventListener('click', event => {
                if (event.target === modal) {
                    hideModal();
                }
            });
            supportTimer = setTimeout(() => {
                modal.classList.add('visible');
                modal.setAttribute('aria-hidden', 'false');
            }, 45000);
        }

        function showLoader() {
            if (loaderElement) {
                loaderElement.classList.remove('hidden');
            }
        }

        function hideLoader() {
            if (loaderElement) {
                loaderElement.classList.add('hidden');
            }
        }

        function showTab(event, tabId) {
            document.querySelectorAll('.content').forEach(section => section.classList.remove('active'));
            const activeSection = document.getElementById(tabId);
            if (activeSection) {
                activeSection.classList.add('active');
            }
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        async function fetchYoutubeTitle(video) {
            const cacheKey = video.id;
            if (youtubeTitleCache.has(cacheKey)) {
                return youtubeTitleCache.get(cacheKey);
            }

            const targetUrl = video.url && video.url.includes('youtube')
                ? video.url
                : `https://www.youtube.com/watch?v=${video.id}`;
            const endpoint = `https://noembed.com/embed?url=${encodeURIComponent(targetUrl)}`;

            try {
                const response = await fetch(endpoint);
                if (!response.ok) throw new Error('NoEmbed failed');
                const data = await response.json();
                const title = data.title || video.label || `YouTube Video (${video.id})`;
                youtubeTitleCache.set(cacheKey, title);
                return title;
            } catch (error) {
                const fallback = video.label || `YouTube Video (${video.id})`;
                youtubeTitleCache.set(cacheKey, fallback);
                return fallback;
            }
        }
    </script>
</body>
</html>
